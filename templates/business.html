{% extends "base.html" %}

{% block title %}{{ business.name }} - Business Analysis{% endblock %}

{% block content %}
<header class="page-header business-header">
    <div class="header-content">
        <span class="business-type-badge {{ business.type }}">{{ business.type | replace('_', ' ') | title }}</span>
        <h1>{{ business.name }}</h1>
        {% if business.description %}
        <p class="description">{{ business.description }}</p>
        {% endif %}
        {% if business.strategic_question %}
        <p class="strategic-question"><strong>Strategic Question:</strong> {{ business.strategic_question }}</p>
        {% endif %}
    </div>
    <div class="header-actions">
        <button class="btn btn-secondary" onclick="showModal('edit-business-modal')">Edit</button>
        <form action="{{ url_for('delete_business', business_id=business.id) }}" method="POST" class="inline-form"
            onsubmit="return confirm('Delete this business and all its data?');">
            <button type="submit" class="btn btn-danger">Delete</button>
        </form>
    </div>
</header>

<!-- Tabs -->
<nav class="tabs">
    <button class="tab active" data-tab="research">üìö Research</button>
    <button class="tab" data-tab="analysis">üìä Analysis</button>
    <button class="tab" data-tab="scenario-planning">üéØ Scenario Planning</button>
    <button class="tab" data-tab="summary">üìù Summary</button>
</nav>

<!-- Research Tab -->
<section id="research" class="tab-content active">
    <div class="section-header">
        <h2>Research Items</h2>
        <button class="btn btn-primary" onclick="showModal('add-research-modal')">+ Add Item</button>
    </div>

    <div class="research-items">
        {% for item in research_items %}
        <div class="research-item" data-item-id="{{ item.id }}">
            <div class="item-header">
                <span class="item-type-badge">{{ item.item_type }}</span>
                <h3>{{ item.title }}</h3>
                <div class="item-actions">
                    <button class="btn btn-sm" onclick="toggleItemContent({{ item.id }})">View</button>
                    <button class="btn btn-sm" onclick="showEditResearchModal({{ item.id }})">Edit</button>
                    <form action="{{ url_for('delete_research_item', item_id=item.id) }}" method="POST"
                        class="inline-form">
                        <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                    </form>
                </div>
            </div>
            {% if item.source_reference %}
            <p class="source-reference">üìé {{ item.source_reference }}</p>
            {% endif %}

            <!-- Quotes -->
            {% if item.quotes %}
            <div class="quotes-summary">
                <strong>{{ item.quotes|length }} quote(s):</strong>
                {% for quote in item.quotes[:3] %}
                <span class="quote-preview">"{{ quote.text[:50] }}..."</span>
                {% endfor %}
            </div>
            {% endif %}

            <!-- Expandable content -->
            <div class="item-content" id="content-{{ item.id }}" style="display: none;">
                <div class="text-container" data-item-id="{{ item.id }}" data-quotes='{{ item.quotes | tojson }}'>
                    <div class="text-content">{{ item.plain_text }}</div>
                </div>
                <div class="quote-actions">
                    <p class="hint">Select text to create a quote</p>
                    <div class="quotes-list">
                        {% for quote in item.quotes %}
                        <div class="quote" data-quote-id="{{ quote.id }}">
                            <span class="quote-text">"{{ quote.text }}"</span>
                            <button class="remove-quote" onclick="deleteQuote({{ quote.id }})">&times;</button>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="empty-state">
            <p>No research items yet. Add articles, notes, or interviews to analyze.</p>
        </div>
        {% endfor %}
    </div>
</section>

<!-- Analysis Tab -->
<section id="analysis" class="tab-content">
    <div class="section-header">
        <h2>Analysis Frameworks</h2>
        <button class="btn btn-primary" onclick="showModal('add-analysis-modal')">+ Add Analysis</button>
    </div>

    <div class="analysis-frameworks" data-business-id="{{ business.id }}">
        {% if analyses %}
        {% for a in analyses %}
        <div class="analysis-framework" data-analysis-id="{{ a.id }}" data-slug="{{ a.template_type }}">
            <div class="framework-header" onclick="toggleFramework('analysis-{{ a.id }}')">
                <div class="framework-title">
                    <span class="analysis-type-badge">{{ a.template.name if a.template else a.template_type }}</span>
                    <input type="text" class="analysis-name-input" value="{{ a.name }}"
                        onclick="event.stopPropagation()" onchange="updateAnalysisName({{ a.id }}, this.value)">
                </div>
                <div class="framework-actions">
                    <button type="button" class="btn btn-sm btn-danger"
                        onclick="event.stopPropagation(); deleteAnalysis({{ a.id }}, '{{ a.name }}')">&times;</button>
                    <span class="toggle-icon">‚ñº</span>
                </div>
            </div>
            <div class="framework-content" id="framework-analysis-{{ a.id }}" style="display: none;">
                <form class="analysis-form" data-business-id="{{ business.id }}" data-analysis-id="{{ a.id }}"
                    data-slug="{{ a.template_type }}">
                    {{ a.template.get_html_form(a.data) | safe }}
                    <div class="form-actions">
                        <span id="status-{{ a.id }}" class="save-status"
                            style="opacity: 0; color: green; margin-right: 10px; transition: opacity 0.5s;">Saved</span>
                        <a href="{{ url_for('get_analysis_text', business_id=business.id, slug=a.template_type) }}"
                            class="btn btn-secondary view-text-btn" data-title="{{ a.name }}">View as Text</a>
                    </div>
                </form>
            </div>
        </div>
        {% endfor %}
        {% else %}
        <div class="empty-state" id="analysis-empty-state">
            <p>No analyses yet. Click "+ Add Analysis" to create your first analysis.</p>
        </div>
        {% endif %}
    </div>
</section>

<!-- Scenario Planning Tab -->
<section id="scenario-planning" class="tab-content">
    <div class="section-header">
        <h2>Scenario Planning</h2>
        <div class="scenario-actions">
            <button class="btn btn-secondary" onclick="addStrategy()">+ Add Strategy</button>
            <button class="btn btn-secondary" onclick="addFuture()">+ Add Future</button>
        </div>
    </div>

    <div class="scenario-planning" data-business-id="{{ business.id }}">
        {% if scenario_planning.strategies or scenario_planning.futures %}
        <div class="scenario-grid-container">
            <table class="scenario-grid">
                <thead>
                    <tr>
                        <th class="corner-cell">Futures \ Strategies</th>
                        {% for strategy in scenario_planning.strategies %}
                        <th class="strategy-header" data-id="{{ strategy.id }}">
                            <div class="header-content">
                                <input type="text" class="strategy-name" value="{{ strategy.name }}"
                                    placeholder="Strategy name">
                                <button type="button" class="remove-btn"
                                    onclick="event.stopPropagation(); event.preventDefault(); removeStrategy('{{ strategy.id }}'); return false;">√ó</button>
                            </div>
                        </th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for future in scenario_planning.futures %}
                    <tr data-future-id="{{ future.id }}">
                        <td class="future-header">
                            <div class="header-content">
                                <input type="text" class="future-name" value="{{ future.name }}"
                                    placeholder="Future name">
                                <button type="button" class="remove-btn"
                                    onclick="event.stopPropagation(); event.preventDefault(); removeFuture('{{ future.id }}'); return false;">√ó</button>
                            </div>
                        </td>
                        {% for strategy in scenario_planning.strategies %}
                        {% set cell_key = strategy.id ~ "_" ~ future.id %}
                        {% set cell = scenario_planning.cells.get(cell_key, {}) %}
                        <td class="scenario-cell {% if cell.summary %}has-summary{% endif %}"
                            data-strategy-id="{{ strategy.id }}" data-future-id="{{ future.id }}"
                            onclick="selectScenarioCell('{{ strategy.id }}', '{{ future.id }}')">
                            <span class="cell-summary">{{ cell.summary or '‚Äî' }}</span>
                        </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-state">
            <p>No strategies or futures defined yet. Add strategies (columns) and possible futures (rows) to start
                scenario planning.</p>
        </div>
        {% endif %}

        <!-- Detail Panel -->
        <div id="scenario-detail-panel" class="scenario-detail-panel" style="display: none;">
            <div class="detail-header">
                <h3>Scenario Analysis</h3>
                <button class="close-btn" onclick="closeScenarioDetail()">√ó</button>
            </div>
            <div class="detail-content">
                <div class="detail-descriptions">
                    <div class="description-box">
                        <label id="strategy-description-label">Strategy Description</label>
                        <textarea id="strategy-description" placeholder="Describe this strategy..."></textarea>
                    </div>
                    <div class="description-box">
                        <label id="future-description-label">Future Description</label>
                        <textarea id="future-description" placeholder="Describe this possible future..."></textarea>
                    </div>
                </div>
                <div class="detail-analysis">
                    <label>Your Analysis</label>
                    <textarea id="cell-thoughts"
                        placeholder="How does this strategy perform in this future? What are the implications?"></textarea>
                </div>
                <div class="detail-summary">
                    <label>Summary (shown in grid)</label>
                    <input type="text" id="cell-summary" placeholder="Brief summary for the grid cell">
                </div>
            </div>
            <div class="form-actions">
                <span id="scenario-save-status" class="save-status"></span>
            </div>
        </div>
    </div>
</section>

<!-- Summary Tab -->
<section id="summary" class="tab-content">
    <div class="section-header">
        <h2>Summary</h2>
        <div class="summary-actions">
            <a href="{{ url_for('export_summary_pdf', business_id=business.id) }}" class="btn btn-secondary">üìÑ Export
                PDF</a>
        </div>
    </div>

    <div class="summary-editor">
        <div class="editor-tabs">
            <button class="editor-tab active" data-view="edit">Edit</button>
            <button class="editor-tab" data-view="preview">Preview</button>
        </div>

        <div class="editor-content">
            <textarea id="summary-markdown"
                placeholder="Write your analysis summary in Markdown...&#10;&#10;You can reference your research and analyses here to build a comprehensive recommendation."
                data-business-id="{{ business.id }}">{{ summary.markdown_content if summary else '' }}</textarea>
            <div id="summary-preview" class="markdown-preview" style="display: none;"></div>
        </div>

        <div class="form-actions">
            <span id="summary-save-status" class="save-status"
                style="margin-right: 1rem; color: var(--color-text-light); font-size: 0.9rem; transition: opacity 0.5s;"></span>
            <button class="btn btn-primary" onclick="saveSummary()">Save Summary</button>
        </div>
    </div>
</section>

<!-- Edit Business Modal -->
<div id="edit-business-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Edit Business</h2>
            <button class="close-btn" onclick="hideModal('edit-business-modal')">&times;</button>
        </div>
        <form action="{{ url_for('update_business', business_id=business.id) }}" method="POST">
            <div class="form-group">
                <label for="edit-name">Business Name *</label>
                <input type="text" id="edit-name" name="name" value="{{ business.name }}" required>
            </div>

            <div class="form-group">
                <label for="edit-type">Type *</label>
                <select id="edit-type" name="type" required>
                    {% for t in business_types %}
                    <option value="{{ t }}" {% if t==business.type %}selected{% endif %}>{{ t | replace('_', ' ') |
                        title }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="edit-description">Description</label>
                <textarea id="edit-description" name="description" rows="3">{{ business.description }}</textarea>
            </div>

            <div class="form-group">
                <label for="edit-strategic_question">Strategic Question</label>
                <input type="text" id="edit-strategic_question" name="strategic_question"
                    value="{{ business.strategic_question }}">
            </div>

            <div class="form-actions">
                <button type="button" class="btn btn-secondary"
                    onclick="hideModal('edit-business-modal')">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Changes</button>
            </div>
        </form>
    </div>
</div>

<!-- Add Research Modal -->
<div id="add-research-modal" class="modal">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h2>Add Research Item</h2>
            <button class="close-btn" onclick="hideModal('add-research-modal')">&times;</button>
        </div>
        <form action="{{ url_for('create_research_item', business_id=business.id) }}" method="POST"
            enctype="multipart/form-data">
            <div class="form-group">
                <label for="research-title">Title *</label>
                <input type="text" id="research-title" name="title" required placeholder="e.g., Q3 Earnings Report">
            </div>

            <div class="form-group">
                <label for="research-type">Type *</label>
                <select id="research-type" name="type" required>
                    {% for t in research_types %}
                    <option value="{{ t }}">{{ t | title }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="research-source">Source Reference</label>
                <input type="text" id="research-source" name="source_reference"
                    placeholder="URL, book reference, interview details...">
            </div>

            <div class="form-group">
                <label for="research-file">Upload File (PDF or Audio)</label>
                <input type="file" id="research-file" name="file" accept=".pdf,.mp3,.wav,.m4a,.ogg,.flac">
                <p class="hint">Text will be automatically extracted from PDFs. Audio files will be transcribed.</p>
            </div>

            <div class="form-group">
                <label for="research-text">Plain Text Content</label>
                <textarea id="research-text" name="plain_text" rows="10"
                    placeholder="Paste or type the relevant content here..."></textarea>
                <p class="hint">If you upload a file, this will be auto-filled. You can also paste text manually.</p>
            </div>

            <div class="form-actions">
                <button type="button" class="btn btn-secondary"
                    onclick="hideModal('add-research-modal')">Cancel</button>
                <button type="submit" class="btn btn-primary">Add Item</button>
            </div>
        </form>
    </div>
</div>

<!-- Add Analysis Modal -->
<div id="add-analysis-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Add New Analysis</h2>
            <button class="close-btn" onclick="hideModal('add-analysis-modal')">&times;</button>
        </div>
        <form id="add-analysis-form" data-business-id="{{ business.id }}"
            onsubmit="event.preventDefault(); createNewAnalysis()">
            <div class="form-group">
                <label for="analysis-type">Analysis Type *</label>
                <select id="analysis-type" required onchange="updateDefaultName()">
                    <option value="">Select an analysis type...</option>
                    {% for template in analysis_templates %}
                    <option value="{{ template.slug }}" data-name="{{ template.name }}">{{ template.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="analysis-name">Analysis Name *</label>
                <input type="text" id="analysis-name" required placeholder="Enter a name for this analysis">
                <p class="hint">Give your analysis a descriptive name (defaults to the template name)</p>
            </div>

            <div class="form-actions">
                <button type="button" class="btn btn-secondary"
                    onclick="hideModal('add-analysis-modal')">Cancel</button>
                <button type="submit" class="btn btn-primary">Add Analysis</button>
            </div>
        </form>
    </div>
</div>

<!-- Store research items data for JS -->
<script>
    window.researchItems = {{ research_items | tojson }};
    window.scenarioPlanning = {{ scenario_planning | tojson }};
    window.analysisTemplates = [
        {% for template in analysis_templates %}
    { slug: "{{ template.slug }}", name: "{{ template.name }}" } {% if not loop.last %}, {% endif %}
    {% endfor %}
    ];
</script>
<!-- View Text Modal -->
<div id="text-view-modal" class="modal">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h2 id="text-view-title">Analysis Text</h2>
            <button class="close-btn" onclick="hideModal('text-view-modal')">&times;</button>
        </div>
        <div class="modal-body" style="padding: 1.5rem;">
            <pre id="text-view-content"
                style="white-space: pre-wrap; padding: 1rem; background: var(--color-bg); border: 1px solid var(--color-border); border-radius: var(--radius-md); font-family: monospace; color: var(--color-text); max-height: 60vh; overflow-y: auto;"></pre>
        </div>
        <div class="form-actions"
            style="padding: 1rem 1.5rem; justify-content: flex-end; border-top: 1px solid var(--color-border);">
            <button type="button" class="btn btn-secondary" onclick="copyToClipboard()">Copy to Clipboard</button>
            <button type="button" class="btn btn-primary" onclick="hideModal('text-view-modal')">Close</button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
<script src="{{ url_for('static', filename='js/quote-highlighter.js') }}"></script>
<script src="{{ url_for('static', filename='js/analysis-forms.js') }}"></script>
<script>
    // Handle "View as Text" clicks
    document.addEventListener('click', (e) => {
        if (e.target.matches('.view-text-btn')) {
            e.preventDefault();
            const url = e.target.href;
            const title = e.target.dataset.title;
            showTextModal(title, url);
        }
    });

    function showTextModal(title, url) {
        document.getElementById('text-view-title').textContent = title + " - Text View";
        const contentArea = document.getElementById('text-view-content');
        contentArea.textContent = 'Loading...';

        showModal('text-view-modal');

        fetch(url)
            .then(res => res.text())
            .then(text => {
                contentArea.textContent = text;
            })
            .catch(err => {
                contentArea.textContent = 'Error loading text: ' + err;
            });
    }

    function copyToClipboard() {
        const text = document.getElementById('text-view-content').textContent;
        navigator.clipboard.writeText(text).then(() => {
            showNotification('Copied to clipboard!', 'success');
        });
    }
</script>
{% endblock %}